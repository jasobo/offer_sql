ALTER SESSION SET "_ORACLE_SCRIPT"= true;
CREATE USER C##JAN IDENTIFIED BY ghi084572;



CREATE TABLE OFFER_TYPES
(
    type_Id   NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    type_Name VARCHAR2(50) NOT NULL
);

INSERT INTO OFFER_TYPES (type_Name)
VALUES ('HEALTH_OFFER');
INSERT INTO OFFER_TYPES (type_Name)
VALUES ('LIFE_OFFER');
INSERT INTO OFFER_TYPES (type_Name)
VALUES ('CAR_OFFER');
INSERT INTO OFFER_TYPES (type_Name)
VALUES ('ACCIDENT_OFFER');

CREATE TABLE OFFERS
(
    offer_Id      NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    offer_Nr      VARCHAR2(6),
    offer_Name    VARCHAR2(50)  NOT NULL,
    offer_Type    NUMBER        NOT NULL,
    price         NUMBER(10, 2) NOT NULL,
    creation_Date DATE DEFAULT TRUNC(SYSDATE),
    valid_Until   DATE,
    CONSTRAINT fk_offers_offersType FOREIGN KEY (offer_Type) REFERENCES OFFER_TYPES (type_Id)
);

CREATE TABLE VALID_UNTIL_DATE
(
    validity_Id   NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    type_Id       NUMBER NOT NULL,
    validity_duration NUMBER NOT NULL,
    CONSTRAINT fk_validUntilDay_offerType FOREIGN KEY (type_Id) REFERENCES OFFER_TYPES(type_Id)

);

INSERT INTO VALID_UNTIL_DATE(type_Id, validity_duration)
VALUES (1, 90);
INSERT INTO VALID_UNTIL_DATE(type_Id, validity_duration)
VALUES (2, 365);
INSERT INTO VALID_UNTIL_DATE(type_Id, validity_duration)
VALUES (3, 30);
INSERT INTO VALID_UNTIL_DATE(type_Id, validity_duration)
VALUES (4, 60);

CREATE TABLE OFFER_LOG
(
    id             NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    offer_Id       NUMBER,
    operation_Type VARCHAR(50),
    operation_Time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_offerLog_offers FOREIGN KEY (offer_Id) REFERENCES OFFERS (offer_Id)
);

CREATE TABLE PERSON
(
    person_Id  NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    person_Nr  VARCHAR2(6),
    first_Name VARCHAR2(50) NOT NULL,
    last_Name  VARCHAR2(50) NOT NULL,
    birthday   DATE         NOT NULL,
    street     VARCHAR2(50),
    city       VARCHAR2(50)
);

CREATE OR REPLACE TRIGGER trigger_offer
    AFTER INSERT OR UPDATE OR DELETE
    ON OFFERS
    FOR EACH ROW
BEGIN
    IF INSERTING THEN
        INSERT INTO OFFER_LOG (offer_Id, operation_Type, operation_Time) VALUES (:NEW.offer_Id, 'INSERT', SYSDATE);
    ELSIF UPDATING THEN
        INSERT INTO OFFER_LOG (offer_Id, operation_Type, operation_Time) VALUES (:NEW.offer_Id, 'UPDATE', SYSDATE);
    ELSIF DELETING THEN
        INSERT INTO OFFER_LOG (offer_Id, operation_Type, operation_Time) VALUES (:OLD.offer_Id, 'DELETE', SYSDATE);
    END IF;
END;


COMMIT;

CREATE USER C##Jan IDENTIFIED BY ghi084572;
GRANT CONNECT, RESOURCE, DBA TO C##Jan;


CREATE OR REPLACE PROCEDURE DELETE_EXPIRED_OFFERS IS
BEGIN
    DELETE
    FROM C##JAN.OFFERS
    WHERE VALID_UNTIL < TRUNC(SYSDATE);

    COMMIT;
END;


BEGIN
    DBMS_SCHEDULER.CREATE_JOB(
            job_name => 'DELETE_EXPIRED_OFFERS_JOB',
            job_type => 'PLSQL_BLOCK',
            job_action => 'BEGIN DELETE_EXPIRED_OFFERS; END;',
            start_date => SYSTIMESTAMP,
            repeat_interval => 'FREQ=DAILY; BYHOUR=0; BYMINUTE=0; BYSECOND=0',
            enabled => TRUE
    );
END;

CREATE OR REPLACE TRIGGER set_valid_until
    BEFORE INSERT ON OFFERS
    FOR EACH ROW
DECLARE
    v_validity_duration NUMBER;
BEGIN
    IF :NEW.valid_until IS NULL THEN
        SELECT validity_duration
        INTO v_validity_duration
        FROM VALID_UNTIL_DATE
        WHERE type_Id = :NEW.offer_Type;
        IF v_validity_duration IS NULL THEN
            RAISE_APPLICATION_ERROR(-20001, 'Keine Gültigkeitsdauer für diesen Angebotstyp gefunden.');
        END IF;
        :NEW.valid_until := SYSDATE + v_validity_duration;
    END IF;
END;

COMMIT;


ALTER TABLE OFFER_LOG DROP CONSTRAINT fk_offerLog_offers;
ALTER TABLE OFFERS DROP CONSTRAINT FK_OFFERS_OFFERSTYPE;
DROP TABLE OFFER_LOG;
DROP TABLE OFFERS;
DROP TABLE OFFER_TYPES;
DROP TABLE PERSON;

INSERT INTO OFFERS(offer_Name, offer_Type, price, valid_Until)
VALUES ('New Car Insurence', 3, 250, '2024-09-17');
INSERT INTO OFFERS(offer_Name, offer_Type, price)
VALUES ('New Car Insurance', 3, 250);
